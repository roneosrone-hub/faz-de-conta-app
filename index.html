<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Faz de Conta Decora√ß√µes ‚Ä¢ Montagem</title>

  <style>
    :root{
      --bg0:#070916;
      --bg1:#0b1230;
      --card: rgba(255,255,255,.08);
      --card2: rgba(255,255,255,.06);
      --stroke: rgba(255,255,255,.14);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.65);
      --muted2: rgba(255,255,255,.45);
      --shadow: 0 18px 50px rgba(0,0,0,.55);
      --radius: 20px;
      --radius2: 16px;
      --accent1:#00f2ff;
      --accent2:#9d00ff;
      --accent3:#ff00c8;
      --good:#2bf48b;
      --warn:#ffcc66;
      --bad:#ff5d6c;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background:
        radial-gradient(1200px 700px at 20% -10%, rgba(157,0,255,.25), transparent 55%),
        radial-gradient(900px 600px at 70% 0%, rgba(0,242,255,.18), transparent 60%),
        radial-gradient(900px 600px at 80% 100%, rgba(255,0,200,.12), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      color:var(--text);
      overflow-x:hidden;
    }

    .wrap{
      width:min(1200px, 92vw);
      margin:18px auto 30px;
      display:flex;
      flex-direction:column;
      gap:14px;
    }

    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:10px 14px;
      border-radius:999px;
      background:rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.10);
      backdrop-filter: blur(10px);
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:6px 10px;
      border-radius:999px;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      color:var(--muted);
      font-size:12.5px;
      user-select:none;
      white-space:nowrap;
    }

    .grid{
      display:grid;
      grid-template-columns: 1.25fr .75fr;
      gap:14px;
    }

    @media (max-width: 960px){
      .grid{ grid-template-columns: 1fr; }
    }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.05));
      border:1px solid rgba(255,255,255,.12);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }

    .header{
      display:flex;
      gap:14px;
      padding:16px;
      align-items:center;
      background:
        radial-gradient(800px 260px at 10% 0%, rgba(157,0,255,.22), transparent 60%),
        radial-gradient(700px 240px at 60% 10%, rgba(0,242,255,.16), transparent 60%),
        radial-gradient(700px 240px at 90% 20%, rgba(255,0,200,.12), transparent 60%),
        rgba(255,255,255,.04);
      border-bottom:1px solid rgba(255,255,255,.10);
    }

    .logo{
      width:78px;height:78px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.25);
      overflow:hidden;
      flex:0 0 auto;
    }
    .logo img{ width:100%;height:100%;object-fit:cover;display:block; }

    .brand{
      flex:1;
      min-width: 0;
    }

    .brand h1{
      margin:0;
      font-size:28px;
      line-height:1.05;
      letter-spacing:.4px;
      background: linear-gradient(90deg, var(--accent1), var(--accent2), var(--accent3));
      -webkit-background-clip:text;
      background-clip:text;
      color:transparent;
      text-shadow: 0 12px 40px rgba(0,0,0,.35);
    }
    .brand .slogan{
      margin:6px 0 0;
      color:rgba(255,255,255,.88);
      font-weight:700;
      letter-spacing:.2px;
      display:flex;
      align-items:center;
      gap:8px;
      font-size:14px;
    }

    .actions{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }

    .btn{
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.07);
      color:var(--text);
      padding:10px 12px;
      border-radius:14px;
      font-weight:700;
      font-size:13px;
      cursor:pointer;
      transition: transform .08s ease, background .2s ease, border-color .2s ease;
      user-select:none;
    }
    .btn:active{ transform: translateY(1px); }
    .btn.primary{
      background: linear-gradient(90deg, rgba(0,242,255,.22), rgba(157,0,255,.18));
      border-color: rgba(0,242,255,.25);
    }
    .btn.good{
      background: linear-gradient(90deg, rgba(43,244,139,.22), rgba(0,242,255,.15));
      border-color: rgba(43,244,139,.28);
    }
    .btn.danger{
      background: rgba(255,93,108,.14);
      border-color: rgba(255,93,108,.24);
    }

    .metaCol{
      display:flex;
      flex-direction:column;
      gap:8px;
      margin-top:10px;
    }

    .metaRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:10px 12px;
      border-radius:14px;
      background: rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.10);
      color:var(--muted);
      font-size:13px;
    }
    .metaRow b{ color:rgba(255,255,255,.9); font-weight:800; }
    .small{ color:var(--muted2); font-size:12px; }

    .body{
      padding:14px;
      display:flex;
      flex-direction:column;
      gap:12px;
    }

    .canvasWrap{
      background:
        radial-gradient(900px 500px at 30% 0%, rgba(157,0,255,.15), transparent 60%),
        radial-gradient(900px 500px at 80% 100%, rgba(0,242,255,.10), transparent 60%),
        linear-gradient(160deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid rgba(255,255,255,.12);
      border-radius: var(--radius2);
      overflow:hidden;
      position:relative;
      min-height:420px;
    }

    .canvasTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:10px 12px;
      border-bottom:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
    }
    .canvasTop .title{
      display:flex;
      align-items:center;
      gap:8px;
      font-weight:900;
      letter-spacing:.2px;
    }

    #stage{
      position:relative;
      height: min(520px, 60vh);
      min-height: 380px;
      overflow:hidden;
      touch-action:none;
    }

    .item{
      position:absolute;
      left:120px; top:120px;
      transform-origin:center center;
      cursor:grab;
      user-select:none;
      touch-action:none;
      filter: drop-shadow(0 18px 26px rgba(0,0,0,.35));
    }
    .item:active{ cursor:grabbing; }

    .item img{
      display:block;
      width:220px;
      height:auto;
      pointer-events:none;
      user-select:none;
    }

    .selected{
      outline: 2px solid rgba(0,242,255,.45);
      outline-offset: 6px;
      border-radius: 14px;
    }

    .panel{
      padding:12px;
      background: rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.10);
      border-radius: var(--radius2);
    }

    .panel h3{
      margin:0 0 10px;
      font-size:14px;
      color:rgba(255,255,255,.92);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }

    .row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
    }

    .field{
      width:100%;
      display:flex;
      gap:8px;
    }

    input[type="text"], select{
      width:100%;
      padding:11px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.25);
      color:var(--text);
      outline:none;
    }

    .grid2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    @media (max-width: 960px){
      .grid2{ grid-template-columns: 1fr; }
    }

    .slider{
      width:100%;
      display:flex;
      flex-direction:column;
      gap:6px;
      margin-top:10px;
    }
    .slider label{
      display:flex;
      justify-content:space-between;
      color:var(--muted);
      font-size:12.5px;
    }
    input[type="range"]{ width:100%; }

    .catalog{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    @media (max-width: 520px){
      .catalog{ grid-template-columns: 1fr; }
    }

    .tile{
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12);
      border-radius:16px;
      overflow:hidden;
      cursor:pointer;
      transition: transform .08s ease, border-color .2s ease;
    }
    .tile:active{ transform: translateY(1px); }
    .tile:hover{ border-color: rgba(0,242,255,.22); }

    .thumb{
      height:110px;
      background: rgba(0,0,0,.30);
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
    }
    .thumb img{
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
      opacity:.95;
    }

    .tile .info{
      padding:10px;
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .tile .name{
      font-weight:900;
      font-size:13px;
      color:rgba(255,255,255,.92);
    }
    .tile .desc{
      color:var(--muted);
      font-size:12px;
      min-height: 28px;
    }
    .chip{
      display:inline-flex;
      align-items:center;
      gap:6px;
      font-size:11.5px;
      color:rgba(255,255,255,.86);
      padding:4px 8px;
      border-radius:999px;
      background: rgba(0,0,0,.25);
      border:1px solid rgba(255,255,255,.10);
      width:max-content;
    }

    .hint{
      margin-top:10px;
      color:var(--muted2);
      font-size:12px;
      line-height:1.35;
    }

    .toast{
      position:fixed;
      left:50%;
      bottom:18px;
      transform: translateX(-50%);
      background: rgba(0,0,0,.72);
      border:1px solid rgba(255,255,255,.14);
      color:rgba(255,255,255,.92);
      padding:10px 12px;
      border-radius: 999px;
      font-size:13px;
      box-shadow: 0 20px 60px rgba(0,0,0,.55);
      opacity:0;
      pointer-events:none;
      transition: opacity .2s ease, transform .2s ease;
      z-index:9999;
    }
    .toast.show{
      opacity:1;
      transform: translateX(-50%) translateY(-4px);
    }
  </style>
</head>

<body>
  <div class="wrap">

    <div class="topbar">
      <div class="pill">‚ú® Faz de Conta ‚Ä¢ Montagem</div>
      <div class="pill" id="nowPill">‚è±Ô∏è --/--/---- ‚Ä¢ --:--</div>
    </div>

    <div class="card">
      <div class="header">
        <div class="logo">
          <!-- Troque se quiser: assets/capa.jpg -->
          <img src="assets/capa.jpg" alt="Logo">
        </div>

        <div class="brand">
          <h1>FAZ DE CONTA DECORA√á√ïES</h1>
          <div class="slogan">‚ú® Onde a imagina√ß√£o vira festa</div>

          <!-- METAS EM COLUNA (DE CIMA PRA BAIXO) -->
          <div class="metaCol">
            <div class="metaRow"><span>üìç Cidade</span> <b>Jaciara/MT</b></div>
            <div class="metaRow"><span>üí¨ WhatsApp</span> <b>(66) 99622-3481</b></div>
            <div class="metaRow"><span>üìÖ Data/Hora</span> <b id="dateLine">--/--/---- ‚Ä¢ --:--</b></div>
          </div>
        </div>

        <div class="actions">
          <button class="btn primary" onclick="openWhats()">üí¨ WhatsApp</button>
          <button class="btn" onclick="clearStage()">üßº Limpar montagem</button>
          <button class="btn good" onclick="exportPNG()">üì∏ Exportar imagem</button>
          <button class="btn danger" onclick="deleteSelected()">üóëÔ∏è Apagar item</button>
        </div>
      </div>

      <div class="body">
        <div class="canvasWrap">
          <div class="canvasTop">
            <div class="title">üß© Montagem do cliente</div>
            <div class="small">Toque/clique no item pra selecionar ‚Ä¢ arraste pra mover</div>
          </div>

          <div id="stage" aria-label="√Årea de montagem"></div>
        </div>

        <div class="grid2">
          <div class="panel">
            <h3>
              üéõÔ∏è Controles do item
              <span class="small" id="selName">Selecionado: nenhum</span>
            </h3>

            <div class="row">
              <button class="btn" onclick="bringFront()">‚¨ÜÔ∏è Frente</button>
              <button class="btn" onclick="sendBack()">‚¨áÔ∏è Tr√°s</button>
              <button class="btn" onclick="duplicateSelected()">üß¨ Duplicar</button>
              <button class="btn" onclick="centerSelected()">üéØ Centralizar</button>
            </div>

            <div class="slider">
              <label><span>Escala</span><span id="scaleVal">100%</span></label>
              <input id="scale" type="range" min="20" max="220" value="100" oninput="applyControls()"/>
            </div>

            <div class="slider">
              <label><span>Rota√ß√£o</span><span id="rotVal">0¬∞</span></label>
              <input id="rot" type="range" min="-180" max="180" value="0" oninput="applyControls()"/>
            </div>

            <div class="slider">
              <label><span>Opacidade</span><span id="opaVal">100%</span></label>
              <input id="opa" type="range" min="10" max="100" value="100" oninput="applyControls()"/>
            </div>

            <div class="panel" style="margin-top:12px;">
              <h3>üßº Remover fundo (BETA)</h3>
              <div class="small">
                Isso tenta tirar fundo <b>preto/branco</b> mesmo em JPG, deixando o item ‚Äúsolto‚Äù.
                <br/>Funciona muito bem em bal√µes com fundo preto.
              </div>
              <div class="row" style="margin-top:10px;">
                <button class="btn" onclick="removeBgSelected('auto')">‚ú® Auto</button>
                <button class="btn" onclick="removeBgSelected('black')">‚¨õ Tirar preto</button>
                <button class="btn" onclick="removeBgSelected('white')">‚¨ú Tirar branco</button>
                <button class="btn" onclick="resetImageSelected()">‚Ü©Ô∏è Voltar original</button>
              </div>
              <div class="small" style="margin-top:10px;">
                Dica: se ficar ‚Äúserrilhado‚Äù, use <b>Opacidade</b> 95‚Äì98%.
              </div>
            </div>

          </div>

          <div class="panel">
            <h3>üõí Cat√°logo (toque para adicionar)</h3>

            <div class="field">
              <input id="q" type="text" placeholder="Pesquisar (ex: arco, bal√µes, cortina...)" oninput="renderCatalog()"/>
            </div>

            <div class="field" style="margin-top:10px;">
              <select id="cat" onchange="renderCatalog()">
                <option value="all">üß© Todas as categorias</option>
                <option value="baloes">üéà Bal√µes</option>
                <option value="estruturas">üß± Estruturas</option>
                <option value="fundos">üñºÔ∏è Fundos</option>
                <option value="tapetes">üß∏ Tapetes</option>
                <option value="luz">üí° Ilumina√ß√£o</option>
              </select>
            </div>

            <div class="hint">
              Se o item entrar com ‚Äúfundo‚Äù, selecione ele e use <b>Remover fundo (BETA)</b>.
            </div>

            <div style="height:10px"></div>
            <div class="catalog" id="catalog"></div>

          </div>
        </div>

      </div>
    </div>
  </div>

  <div class="toast" id="toast">Ok</div>

<script>
/** ===============================
 *  CONFIG: ITENS DO CAT√ÅLOGO
 *  =============================== */
const ITEMS = [
  {
    id:"baloes-arco",
    name:"Bal√µes (Arco Org√¢nico)",
    desc:"Bal√µes realistas para montagem. Use remover fundo se precisar.",
    cat:"baloes",
    src:"assets/arco-baloes.jpg"
  },
  {
    id:"arco-1",
    name:"Arco (Estrutura)",
    desc:"Estrutura para bal√µes/painel.",
    cat:"estruturas",
    src:"assets/arco-1.jpg"
  },
  {
    id:"arco-2",
    name:"Arco (Estrutura 2)",
    desc:"Outra op√ß√£o de arco.",
    cat:"estruturas",
    src:"assets/arco-2.jpg"
  },
  {
    id:"cilindros",
    name:"Cilindros (Suporte)",
    desc:"Estruturas para mesa/bolo.",
    cat:"estruturas",
    src:"assets/cilindros.jpg"
  },
  {
    id:"cortina-led",
    name:"Cortina de LED",
    desc:"Ilumina√ß√£o para fundo e brilho.",
    cat:"luz",
    src:"assets/cortina-led.jpg"
  },
  {
    id:"tapete",
    name:"Tapete para fotos",
    desc:"Base para fotos e cen√°rio.",
    cat:"tapetes",
    src:"assets/tapete.jpg"
  },
  {
    id:"painel",
    name:"Painel/Fundo",
    desc:"Use como fundo principal (opcional).",
    cat:"fundos",
    src:"assets/capa.jpg"
  }
];

/** ===============================
 *  ESTADO
 *  =============================== */
const stage = document.getElementById("stage");
let selected = null;
let zTop = 10;

const ui = {
  scale: document.getElementById("scale"),
  rot: document.getElementById("rot"),
  opa: document.getElementById("opa"),
  scaleVal: document.getElementById("scaleVal"),
  rotVal: document.getElementById("rotVal"),
  opaVal: document.getElementById("opaVal"),
  selName: document.getElementById("selName"),
  toast: document.getElementById("toast"),
};

/** ===============================
 *  UTIL
 *  =============================== */
function toast(msg){
  ui.toast.textContent = msg;
  ui.toast.classList.add("show");
  setTimeout(()=>ui.toast.classList.remove("show"), 1600);
}

function nowBr(){
  const d = new Date();
  const dd = String(d.getDate()).padStart(2,'0');
  const mm = String(d.getMonth()+1).padStart(2,'0');
  const yy = d.getFullYear();
  const hh = String(d.getHours()).padStart(2,'0');
  const mi = String(d.getMinutes()).padStart(2,'0');
  return `${dd}/${mm}/${yy} ‚Ä¢ ${hh}:${mi}`;
}

function openWhats(){
  const phone = "5566996223481";
  const txt = encodeURIComponent("Ol√°! Quero montar uma decora√ß√£o. üòä");
  window.open(`https://wa.me/${phone}?text=${txt}`, "_blank");
}

/** ===============================
 *  CAT√ÅLOGO
 *  =============================== */
function renderCatalog(){
  const q = (document.getElementById("q").value || "").toLowerCase().trim();
  const cat = document.getElementById("cat").value;

  const list = ITEMS.filter(it=>{
    const okQ = !q || (it.name.toLowerCase().includes(q) || it.desc.toLowerCase().includes(q));
    const okC = (cat==="all") || (it.cat===cat);
    return okQ && okC;
  });

  const el = document.getElementById("catalog");
  el.innerHTML = "";

  list.forEach(it=>{
    const tile = document.createElement("div");
    tile.className = "tile";
    tile.onclick = ()=> addItem(it);

    tile.innerHTML = `
      <div class="thumb"><img src="${it.src}" alt="${it.name}" onerror="this.style.opacity=.25"></div>
      <div class="info">
        <div class="name">${it.name}</div>
        <div class="desc">${it.desc}</div>
        <div class="chip">üìÅ ${it.cat}</div>
      </div>
    `;
    el.appendChild(tile);
  });

  if(!list.length){
    const empty = document.createElement("div");
    empty.className = "small";
    empty.textContent = "Nada encontrado.";
    el.appendChild(empty);
  }
}

/** ===============================
 *  MONTAGEM: ADD ITEM
 *  =============================== */
function addItem(item){
  const wrap = document.createElement("div");
  wrap.className = "item";
  wrap.dataset.name = item.name;
  wrap.dataset.srcOriginal = item.src;
  wrap.dataset.scale = "100";
  wrap.dataset.rot = "0";
  wrap.dataset.opa = "100";
  wrap.style.zIndex = String(++zTop);

  const img = document.createElement("img");
  img.src = item.src;
  img.alt = item.name;
  img.draggable = false;

  // Se n√£o carregar, avisa (igual seu erro)
  img.onerror = ()=>{
    toast(`N√£o carregou: ${item.src} (confira se existe em /assets)`);
  };

  wrap.appendChild(img);
  stage.appendChild(wrap);

  // posi√ß√£o inicial
  const r = stage.getBoundingClientRect();
  wrap.style.left = Math.max(20, (r.width/2 - 120)) + "px";
  wrap.style.top  = Math.max(20, (r.height/2 - 120)) + "px";

  enableDrag(wrap);
  select(wrap);

  toast("Item adicionado. Toque nele para editar.");
}

/** ===============================
 *  SELE√á√ÉO / CONTROLES
 *  =============================== */
function select(el){
  if(selected) selected.classList.remove("selected");
  selected = el;
  if(selected){
    selected.classList.add("selected");
    ui.selName.textContent = `Selecionado: ${selected.dataset.name}`;
    ui.scale.value = selected.dataset.scale || "100";
    ui.rot.value   = selected.dataset.rot   || "0";
    ui.opa.value   = selected.dataset.opa   || "100";
    applyControls(false);
  }else{
    ui.selName.textContent = "Selecionado: nenhum";
  }
}

function applyControls(updateSelected=true){
  const s = Number(ui.scale.value);
  const r = Number(ui.rot.value);
  const o = Number(ui.opa.value);

  ui.scaleVal.textContent = `${s}%`;
  ui.rotVal.textContent   = `${r}¬∞`;
  ui.opaVal.textContent   = `${o}%`;

  if(!selected) return;

  if(updateSelected){
    selected.dataset.scale = String(s);
    selected.dataset.rot   = String(r);
    selected.dataset.opa   = String(o);
  }

  selected.style.transform = `rotate(${r}deg) scale(${s/100})`;
  selected.style.opacity = String(o/100);
}

function bringFront(){
  if(!selected) return;
  selected.style.zIndex = String(++zTop);
  toast("Trouxe pra frente");
}

function sendBack(){
  if(!selected) return;
  selected.style.zIndex = "1";
  toast("Mandou pra tr√°s");
}

function duplicateSelected(){
  if(!selected) return;
  const src = selected.querySelector("img").src;
  const name = selected.dataset.name + " (c√≥pia)";
  const fake = { name, desc:"", cat:"", src: selected.dataset.srcOriginal || src };
  addItem(fake);
  // copiar estado
  if(selected){
    ui.scale.value = selected.dataset.scale || "100";
    ui.rot.value = selected.dataset.rot || "0";
    ui.opa.value = selected.dataset.opa || "100";
  }
  toast("Duplicado");
}

function deleteSelected(){
  if(!selected) { toast("Selecione um item"); return; }
  const old = selected;
  select(null);
  old.remove();
  toast("Item apagado");
}

function centerSelected(){
  if(!selected) return;
  const r = stage.getBoundingClientRect();
  selected.style.left = (r.width/2 - 120) + "px";
  selected.style.top  = (r.height/2 - 120) + "px";
  toast("Centralizado");
}

function clearStage(){
  stage.innerHTML = "";
  selected = null;
  ui.selName.textContent = "Selecionado: nenhum";
  toast("Montagem limpa");
}

/** ===============================
 *  DRAG (mouse + touch)
 *  =============================== */
function enableDrag(el){
  el.addEventListener("mousedown", startDrag);
  el.addEventListener("touchstart", startDrag, {passive:false});
  el.addEventListener("click", (e)=>{ e.stopPropagation(); select(el); });
}

let dragState = null;

function startDrag(e){
  e.preventDefault();
  const el = e.currentTarget;
  select(el);
  const p = getPoint(e);
  const rect = el.getBoundingClientRect();
  const parent = stage.getBoundingClientRect();
  dragState = {
    el,
    startX: p.x,
    startY: p.y,
    offX: rect.left - parent.left,
    offY: rect.top - parent.top
  };
  window.addEventListener("mousemove", onDrag);
  window.addEventListener("touchmove", onDrag, {passive:false});
  window.addEventListener("mouseup", endDrag);
  window.addEventListener("touchend", endDrag);
}

function onDrag(e){
  if(!dragState) return;
  e.preventDefault();
  const p = getPoint(e);
  const dx = p.x - dragState.startX;
  const dy = p.y - dragState.startY;

  let x = dragState.offX + dx;
  let y = dragState.offY + dy;

  // limites leves
  x = Math.max(-80, Math.min(stage.clientWidth - 60, x));
  y = Math.max(-80, Math.min(stage.clientHeight - 60, y));

  dragState.el.style.left = x + "px";
  dragState.el.style.top  = y + "px";
}

function endDrag(){
  dragState = null;
  window.removeEventListener("mousemove", onDrag);
  window.removeEventListener("touchmove", onDrag);
  window.removeEventListener("mouseup", endDrag);
  window.removeEventListener("touchend", endDrag);
}

function getPoint(e){
  if(e.touches && e.touches[0]) return {x:e.touches[0].clientX, y:e.touches[0].clientY};
  return {x:e.clientX, y:e.clientY};
}

stage.addEventListener("click", ()=> select(null));

/** ===============================
 *  REMOVER FUNDO (BETA) - CLIENT SIDE
 *  - funciona mesmo em JPG
 *  - remove preto / branco / auto (detecta pelos cantos)
 *  =============================== */
function removeBgSelected(mode){
  if(!selected){ toast("Selecione um item"); return; }

  const img = selected.querySelector("img");
  const src = selected.dataset.srcOriginal || img.src;

  const im = new Image();
  im.crossOrigin = "anonymous";
  im.onload = ()=>{
    const c = document.createElement("canvas");
    c.width = im.width;
    c.height = im.height;
    const ctx = c.getContext("2d");
    ctx.drawImage(im,0,0);

    const id = ctx.getImageData(0,0,c.width,c.height);
    const data = id.data;

    // pega cor do "fundo" pelos cantos (auto)
    function avgCorner(x0,y0){
      let r=0,g=0,b=0,n=0;
      const step = 4;
      for(let y=y0; y<y0+20; y+=step){
        for(let x=x0; x<x0+20; x+=step){
          const i = (y*c.width + x)*4;
          r += data[i]; g += data[i+1]; b += data[i+2]; n++;
        }
      }
      return {r:r/n,g:g/n,b:b/n};
    }
    const c1 = avgCorner(0,0);
    const c2 = avgCorner(c.width-20,0);
    const c3 = avgCorner(0,c.height-20);
    const c4 = avgCorner(c.width-20,c.height-20);

    const bg = {
      r: (c1.r+c2.r+c3.r+c4.r)/4,
      g: (c1.g+c2.g+c3.g+c4.g)/4,
      b: (c1.b+c2.b+c3.b+c4.b)/4
    };

    // define cor alvo
    let target = bg;
    if(mode==="black") target = {r:0,g:0,b:0};
    if(mode==="white") target = {r:255,g:255,b:255};

    // threshold (quanto maior, remove mais)
    const thr = (mode==="auto") ? 42 : 55;

    // remove pixels parecidos com o fundo
    for(let i=0;i<data.length;i+=4){
      const r=data[i], g=data[i+1], b=data[i+2];
      const dr=r-target.r, dg=g-target.g, db=b-target.b;
      const dist = Math.sqrt(dr*dr+dg*dg+db*db);
      if(dist < thr){
        data[i+3]=0; // alpha 0
      }
    }

    ctx.putImageData(id,0,0);
    const out = c.toDataURL("image/png");
    img.src = out;
    toast("Fundo removido (BETA). Se precisar, use Opacidade 95‚Äì98%");
  };

  im.onerror = ()=>{
    toast("N√£o consegui ler a imagem pra remover fundo. Confira /assets.");
  };

  im.src = src;
}

function resetImageSelected(){
  if(!selected){ toast("Selecione um item"); return; }
  const img = selected.querySelector("img");
  img.src = selected.dataset.srcOriginal || img.src;
  toast("Voltou para original");
}

/** ===============================
 *  EXPORTAR IMAGEM (print do stage)
 *  =============================== */
async function exportPNG(){
  // captura simples: cria um canvas e desenha o fundo + itens
  const r = stage.getBoundingClientRect();
  const c = document.createElement("canvas");
  c.width = Math.round(r.width * 2);
  c.height = Math.round(r.height * 2);
  const ctx = c.getContext("2d");

  // fundo
  const grd = ctx.createLinearGradient(0,0,c.width,c.height);
  grd.addColorStop(0, "#10163a");
  grd.addColorStop(1, "#071022");
  ctx.fillStyle = grd;
  ctx.fillRect(0,0,c.width,c.height);

  // desenhar itens pela ordem de zIndex
  const nodes = Array.from(stage.querySelectorAll(".item"))
    .sort((a,b)=>(Number(a.style.zIndex||0) - Number(b.style.zIndex||0)));

  for(const el of nodes){
    const img = el.querySelector("img");
    // espera carregar
    if(!img.complete) await new Promise(res=>{ img.onload=res; img.onerror=res; });

    const x = parseFloat(el.style.left||"0") * 2;
    const y = parseFloat(el.style.top||"0") * 2;
    const scale = (Number(el.dataset.scale||100)/100);
    const rot = (Number(el.dataset.rot||0) * Math.PI/180);
    const opa = Number(el.dataset.opa||100)/100;

    const w = (img.naturalWidth || 400) * 2;
    const h = (img.naturalHeight || 300) * 2;

    ctx.save();
    ctx.globalAlpha = opa;
    ctx.translate(x + (w/2)*scale, y + (h/2)*scale);
    ctx.rotate(rot);
    ctx.scale(scale, scale);
    ctx.drawImage(img, -w/2, -h/2, w, h);
    ctx.restore();
  }

  const url = c.toDataURL("image/png");
  const a = document.createElement("a");
  a.href = url;
  a.download = "montagem-faz-de-conta.png";
  a.click();

  toast("Imagem exportada!");
}

/** ===============================
 *  INIT
 *  =============================== */
function tickTime(){
  const t = nowBr();
  document.getElementById("nowPill").textContent = "‚è±Ô∏è " + t;
  document.getElementById("dateLine").textContent = t;
}
tickTime();
setInterval(tickTime, 15000);

renderCatalog();
toast("Pronto! Toque em um item do cat√°logo para montar.");
</script>

</body>
</html>
