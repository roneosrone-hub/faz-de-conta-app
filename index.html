<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"/>
  <title>Faz de Conta Decora√ß√µes ‚Ä¢ Montagem</title>
  <style>
    :root{
      --bg0:#070916;
      --bg1:#0b1230;
      --card: rgba(255,255,255,.08);
      --card2: rgba(255,255,255,.06);
      --stroke: rgba(255,255,255,.14);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.65);
      --muted2: rgba(255,255,255,.45);
      --shadow: 0 18px 50px rgba(0,0,0,.55);
      --radius: 22px;
      --radius2: 18px;
      --accentA:#8a5cff;
      --accentB:#19d3ff;
      --accentC:#50ffa7;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color:var(--text);
      background:
        radial-gradient(1200px 800px at 20% 10%, rgba(138,92,255,.22), transparent 55%),
        radial-gradient(900px 700px at 85% 30%, rgba(25,211,255,.18), transparent 60%),
        radial-gradient(900px 700px at 70% 90%, rgba(80,255,167,.12), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
    }
    a{color:inherit}

    .wrap{max-width:1100px;margin:18px auto 34px; padding:0 14px}
    .topNote{
      display:inline-flex; gap:8px; align-items:center;
      padding:6px 10px; border:1px solid var(--stroke);
      background: rgba(255,255,255,.05);
      border-radius:999px; color:var(--muted);
      font-size:12px;
    }
    .grid{
      display:grid;
      grid-template-columns: 1.05fr .95fr;
      gap:14px;
      margin-top:12px;
    }
    @media (max-width: 980px){
      .grid{grid-template-columns:1fr}
    }

    .card{
      border:1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.04));
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .cardPad{padding:14px}

    /* Header */
    .hero{
      display:grid;
      grid-template-columns: 86px 1fr;
      gap:14px;
      align-items:center;
      padding:16px;
      background:
        radial-gradient(700px 260px at 0% 0%, rgba(138,92,255,.24), transparent 60%),
        radial-gradient(700px 260px at 100% 40%, rgba(25,211,255,.18), transparent 65%),
        linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.03));
    }
    .logoBox{
      width:86px;height:86px;border-radius:18px;
      border:1px solid var(--stroke);
      background: rgba(0,0,0,.25);
      overflow:hidden;
      display:flex;align-items:center;justify-content:center;
    }
    .logoBox img{width:100%;height:100%;object-fit:cover;display:block}
    .brand h1{
      margin:0;
      font-size:28px;
      letter-spacing:.6px;
      line-height:1.05;
      background: linear-gradient(90deg, var(--accentA), var(--accentB), var(--accentC));
      -webkit-background-clip:text; background-clip:text; color:transparent;
      text-transform:uppercase;
    }
    .brand .slogan{
      margin-top:6px;
      color: rgba(255,255,255,.90);
      font-weight:800;
      letter-spacing:.2px;
      text-shadow: 0 10px 26px rgba(0,0,0,.45);
      font-size:15px;
    }

    .pills{
      margin-top:10px;
      display:flex; flex-wrap:wrap; gap:8px;
      align-items:center;
    }
    .pill{
      display:inline-flex; gap:8px; align-items:center;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.05);
      font-size:12px; color:var(--muted);
      user-select:none;
    }
    .btn{
      cursor:pointer;
      color:var(--text);
      background: rgba(255,255,255,.07);
      border:1px solid var(--stroke);
      border-radius:999px;
      padding:9px 12px;
      font-weight:700;
      font-size:12px;
      display:inline-flex; align-items:center; gap:8px;
    }
    .btn:hover{background: rgba(255,255,255,.10)}
    .btnPrimary{
      border-color: rgba(138,92,255,.55);
      background: linear-gradient(90deg, rgba(138,92,255,.35), rgba(25,211,255,.18));
    }
    .btnDanger{
      border-color: rgba(255,90,120,.55);
      background: rgba(255,90,120,.12);
    }

    /* Info lines (vertical) */
    .infoLines{
      padding:12px 16px 16px;
      display:grid;
      gap:8px;
    }
    .line{
      display:flex; align-items:center; justify-content:space-between;
      padding:10px 12px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.04);
      border-radius:14px;
      font-size:12px;
      color:var(--muted);
    }
    .line b{color:var(--text); font-weight:800}
    .line .left{display:flex; gap:8px; align-items:center}
    .tag{
      font-size:11px;
      padding:3px 8px;
      border-radius:999px;
      border:1px solid var(--stroke);
      background: rgba(0,0,0,.18);
      color:var(--muted);
    }

    /* Montage */
    .montageHeader{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px; margin-bottom:10px;
    }
    .montageHeader .title{
      display:flex; gap:8px; align-items:center;
      font-weight:900;
    }
    .hint{
      color: var(--muted2);
      font-size:11px;
      max-width:380px;
      text-align:right;
    }

    .stage{
      height: 380px;
      border:1px solid var(--stroke);
      border-radius: var(--radius2);
      background:
        radial-gradient(900px 500px at 20% 10%, rgba(138,92,255,.18), transparent 60%),
        radial-gradient(900px 500px at 85% 35%, rgba(25,211,255,.14), transparent 65%),
        linear-gradient(135deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      position:relative;
      overflow:hidden;
      touch-action:none;
    }
    .stage::after{
      content:"";
      position:absolute; inset:0;
      background: radial-gradient(800px 600px at 50% 70%, rgba(0,0,0,.18), transparent 55%);
      pointer-events:none;
    }
    .stageGrid{
      position:absolute; inset:0;
      background-image:
        linear-gradient(to right, rgba(255,255,255,.05) 1px, transparent 1px),
        linear-gradient(to bottom, rgba(255,255,255,.05) 1px, transparent 1px);
      background-size: 48px 48px;
      opacity:.22;
      pointer-events:none;
    }

    .item{
      position:absolute;
      left:50%; top:50%;
      transform: translate(-50%,-50%) rotate(0deg) scale(1);
      transform-origin:center;
      user-select:none;
      touch-action:none;
    }
    .item img{
      display:block;
      width:240px; height:auto;
      pointer-events:none;
      filter: drop-shadow(0 18px 28px rgba(0,0,0,.45));
    }
    .item.selected{
      outline: 2px solid rgba(25,211,255,.55);
      outline-offset: 4px;
      border-radius: 12px;
    }

    /* Controls */
    .controlsRow{
      display:flex; gap:8px; flex-wrap:wrap; margin-top:10px;
    }
    .slab{
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.04);
      border-radius: var(--radius2);
      padding:12px;
    }
    .slab h3{margin:0 0 10px; font-size:13px}
    .field{display:grid; gap:6px; margin:8px 0}
    .field label{font-size:11px; color:var(--muted)}
    input[type="range"]{width:100%}
    textarea{
      width:100%;
      min-height:84px;
      resize:vertical;
      border-radius:14px;
      border:1px solid var(--stroke);
      background: rgba(0,0,0,.22);
      color:var(--text);
      padding:10px 12px;
      outline:none;
    }
    input[type="text"], select{
      width:100%;
      border-radius:12px;
      border:1px solid var(--stroke);
      background: rgba(0,0,0,.22);
      color:var(--text);
      padding:10px 12px;
      outline:none;
      font-size:13px;
    }

    /* Catalog */
    .catalogHeader{
      display:flex; gap:10px; align-items:center; justify-content:space-between;
      margin-bottom:10px;
    }
    .catalogHeader .left{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
      width:100%;
    }
    .catalogGrid{
      display:grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap:10px;
    }
    @media (max-width:560px){
      .catalogGrid{grid-template-columns:1fr}
    }
    .catCard{
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.04);
      border-radius:18px;
      overflow:hidden;
      cursor:pointer;
      transition: transform .12s ease, background .12s ease;
    }
    .catCard:hover{transform: translateY(-2px); background: rgba(255,255,255,.06)}
    .thumb{
      height:96px;
      background: rgba(0,0,0,.18);
      display:flex; align-items:center; justify-content:center;
      overflow:hidden;
    }
    .thumb img{width:100%; height:100%; object-fit:cover; display:block}
    .catBody{padding:10px 10px 12px}
    .catTitle{font-weight:900; font-size:13px; margin:0 0 4px}
    .catDesc{margin:0; font-size:11px; color:var(--muted)}
    .price{margin-top:8px; font-size:11px; color:var(--muted)}
    .badge{display:inline-flex; padding:3px 8px; border-radius:999px; border:1px solid var(--stroke); font-size:11px; color:var(--muted); background: rgba(0,0,0,.18)}
    .row2{
      display:grid;
      grid-template-columns: 1fr;
      gap:14px;
    }

    .smallNote{font-size:11px;color:var(--muted2);margin-top:8px;line-height:1.35}
    .err{color:#ffb3c2}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topNote">‚ú® Montagem interativa ‚Ä¢ Arraste os itens ‚Ä¢ IA por texto/voz ‚Ä¢ Exporta imagem</div>

    <!-- HEADER -->
    <div class="card" style="margin-top:12px">
      <div class="hero">
        <div class="logoBox">
          <img id="logoImg" src="assets/logo.png" alt="Logo" onerror="this.style.display='none'; this.parentElement.textContent='FC'; this.parentElement.style.fontWeight='900'">
        </div>
        <div class="brand">
          <h1>FAZ DE CONTA DECORA√á√ïES</h1>
          <div class="slogan">‚ú® Onde a imagina√ß√£o vira festa</div>

          <div class="pills">
            <button class="btn" id="btnWhats">üí¨ WhatsApp</button>
            <span class="pill">üõí Selecionados: <b id="selCount" style="color:var(--text)">0</b></span>
            <button class="btn btnDanger" id="btnClearAll">üßπ Limpar montagem</button>
            <button class="btn btnPrimary" id="btnExport">‚¨áÔ∏è Exportar imagem</button>
          </div>
        </div>
      </div>

      <!-- INFO (vertical like you wanted) -->
      <div class="infoLines">
        <div class="line">
          <div class="left">üìç <b>Jaciara/MT</b> <span class="tag">Atendimento</span></div>
          <div class="tag">Faz de Conta</div>
        </div>
        <div class="line">
          <div class="left">üìû <b id="phoneText">(66) 99622-3481</b> <span class="tag">WhatsApp</span></div>
          <button class="btn" id="btnCopy">üìã Copiar</button>
        </div>
        <div class="line">
          <div class="left">üìÖ <b id="dateText">--/--/----</b> <span class="tag">Data</span></div>
          <div class="tag" id="timeText">--:--</div>
        </div>
      </div>
    </div>

    <div class="grid">
      <!-- LEFT: Montage + Controls -->
      <div class="row2">
        <div class="card">
          <div class="cardPad">
            <div class="montageHeader">
              <div class="title">üß© Montagem do cliente</div>
              <div class="hint">Dica: toque no item para selecionar. Arraste para mover. Depois use os controles abaixo.</div>
            </div>

            <div id="stage" class="stage">
              <div class="stageGrid"></div>
              <!-- items injected -->
            </div>

            <div class="controlsRow" style="margin-top:12px">
              <div class="btn" id="btnFront">‚¨ÜÔ∏è Frente</div>
              <div class="btn" id="btnBack">‚¨áÔ∏è Tr√°s</div>
              <div class="btn" id="btnDup">üìå Duplicar</div>
              <div class="btn btnDanger" id="btnDel">üóëÔ∏è Remover</div>
              <div class="btn" id="btnCenter">üéØ Centralizar</div>
            </div>

            <div class="slab" style="margin-top:12px">
              <h3>üéõÔ∏è Ajustes do item selecionado</h3>

              <div class="field">
                <label>Escala (tamanho)</label>
                <input id="rngScale" type="range" min="20" max="220" value="100">
              </div>
              <div class="field">
                <label>Rota√ß√£o</label>
                <input id="rngRot" type="range" min="-180" max="180" value="0">
              </div>
              <div class="field">
                <label>Opacidade</label>
                <input id="rngOp" type="range" min="15" max="100" value="100">
              </div>

              <div class="field">
                <label>Cor (Hue) ‚Äî bom para bal√µes/LED</label>
                <input id="rngHue" type="range" min="0" max="360" value="0">
              </div>
              <div class="field">
                <label>Satura√ß√£o</label>
                <input id="rngSat" type="range" min="0" max="200" value="100">
              </div>

              <div class="controlsRow" style="margin-top:10px">
                <button class="btn" id="btnReset">‚ôªÔ∏è Reset</button>
                <button class="btn" id="btnResetColor">üé® Reset cor</button>
              </div>

              <div class="smallNote">
                Se alguma imagem ‚Äúsumir‚Äù no Vercel: quase sempre √© <b>nome diferente</b> (mai√∫scula/min√∫scula) ou caminho errado.
                Use <b>assets/arquivo.png</b> e nomes simples.
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- RIGHT: IA + Catalog -->
      <div class="row2">
        <div class="card">
          <div class="cardPad">
            <div class="catalogHeader">
              <div class="left" style="flex:1">
                <div style="font-weight:900">ü§ñ Assistente (IA por texto/voz)</div>
                <span class="badge">sem chave ‚Ä¢ autom√°tico inteligente</span>
              </div>
            </div>

            <textarea id="aiText" placeholder="Ex.: tema princesas, arco de bal√µes rosa e lil√°s do lado esquerdo, cortina de LED no fundo, tapete rosa no ch√£o, dois cilindros no centro."></textarea>

            <div class="controlsRow" style="margin-top:10px">
              <button class="btn btnPrimary" id="btnAi">‚ú® Gerar cen√°rio</button>
              <button class="btn" id="btnMic">üéôÔ∏è Falar</button>
              <button class="btn" id="btnAiClear">üßπ Limpar texto</button>
            </div>

            <div id="micStatus" class="smallNote"></div>
            <div id="aiStatus" class="smallNote"></div>
          </div>
        </div>

        <div class="card">
          <div class="cardPad">
            <div class="catalogHeader">
              <div class="left">
                <div style="font-weight:900">üß∫ Itens do cat√°logo</div>
                <span class="badge">clique para adicionar</span>
              </div>
            </div>

            <div style="display:grid; gap:10px">
              <input id="search" type="text" placeholder="Pesquisar (ex: arco, bal√µes, tapete, led, cilindro)">
              <select id="catFilter">
                <option value="all">Todas as categorias</option>
                <option value="bal√µes">Bal√µes</option>
                <option value="estrutura">Estrutura</option>
                <option value="ilumina√ß√£o">Ilumina√ß√£o</option>
                <option value="cen√°rio">Cen√°rio</option>
                <option value="suporte">Suporte</option>
              </select>
            </div>

            <div class="smallNote">
              Se voc√™ quiser trocar imagens depois: s√≥ troque os arquivos dentro de <b>assets/</b> mantendo o mesmo nome.
            </div>

            <div style="margin-top:12px" class="catalogGrid" id="catalog"></div>

            <div id="imgWarn" class="smallNote err" style="display:none;margin-top:10px"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
/* =========================
   CONFIG: SEUS ITENS AQUI
   ========================= */
const CATALOG = [
  {
    id:"baloes",
    name:"Bal√µes (Arco Org√¢nico)",
    category:"bal√µes",
    desc:"Bal√µes para montagem (prefira PNG com fundo transparente).",
    src:"assets/arco-baloes.png",
    w:260
  },
  {
    id:"arco",
    name:"Arco (Estrutura)",
    category:"estrutura",
    desc:"Estrutura do arco. Combine com bal√µes/LED.",
    src:"assets/arco.png",
    w:280
  },
  {
    id:"cilindros",
    name:"Cilindros (Suporte)",
    category:"suporte",
    desc:"Estruturas e suporte para decora√ß√£o.",
    src:"assets/cilindros.png",
    w:260
  },
  {
    id:"led",
    name:"Cortina de LED",
    category:"ilumina√ß√£o",
    desc:"Para fundo e brilho (fica linda com tema).",
    src:"assets/led.png",
    w:320
  },
  {
    id:"tapete",
    name:"Tapete",
    category:"cen√°rio",
    desc:"Base para fotos e cen√°rio.",
    src:"assets/tapete.png",
    w:360
  },
];

/* =========================
   HELPERS
   ========================= */
const $ = (s)=>document.querySelector(s);
const stage = $("#stage");
const catalogEl = $("#catalog");
const selCount = $("#selCount");

let items = []; // {id, catId, name, src, x,y, scale, rot, op, hue, sat, z, w, img}
let selectedId = null;
let zCounter = 10;

function nowDateTime(){
  const d = new Date();
  const dd = String(d.getDate()).padStart(2,"0");
  const mm = String(d.getMonth()+1).padStart(2,"0");
  const yy = d.getFullYear();
  const hh = String(d.getHours()).padStart(2,"0");
  const mi = String(d.getMinutes()).padStart(2,"0");
  $("#dateText").textContent = `${dd}/${mm}/${yy}`;
  $("#timeText").textContent = `${hh}:${mi}`;
}
nowDateTime();
setInterval(nowDateTime, 20000);

/* =========================
   CATALOG RENDER
   ========================= */
function renderCatalog(){
  const q = $("#search").value.trim().toLowerCase();
  const f = $("#catFilter").value;

  catalogEl.innerHTML = "";
  let missing = [];

  CATALOG
    .filter(it=>{
      const okText = (it.name + " " + it.desc).toLowerCase().includes(q);
      const okCat = (f==="all" || it.category===f);
      return okText && okCat;
    })
    .forEach(it=>{
      const card = document.createElement("div");
      card.className="catCard";
      card.innerHTML = `
        <div class="thumb"><img alt="${it.name}" src="${it.src}"></div>
        <div class="catBody">
          <div class="catTitle">${it.name}</div>
          <p class="catDesc">${it.desc}</p>
          <div class="price"><span class="badge">${it.category}</span> &nbsp; <span>Pre√ßo: sob consulta</span></div>
        </div>
      `;

      const img = card.querySelector("img");
      img.onerror = ()=>{ missing.push(it.src); img.style.opacity=.25; };

      card.addEventListener("click", ()=> addItemFromCatalog(it.id));
      catalogEl.appendChild(card);
    });

  // warn (small)
  setTimeout(()=>{
    if(missing.length){
      $("#imgWarn").style.display="block";
      $("#imgWarn").textContent =
        "Algumas imagens n√£o carregaram: " + [...new Set(missing)].join(", ") +
        " ‚Äî confira se existem em assets/ e se o nome est√° id√™ntico (min√∫sculas/sem espa√ßos).";
    }else{
      $("#imgWarn").style.display="none";
    }
  }, 150);
}
$("#search").addEventListener("input", renderCatalog);
$("#catFilter").addEventListener("change", renderCatalog);
renderCatalog();

/* =========================
   ITEMS / STAGE
   ========================= */
function stageRect(){ return stage.getBoundingClientRect(); }

function addItemFromCatalog(catId, opts = {}){
  const cat = CATALOG.find(c=>c.id===catId);
  if(!cat) return;

  const r = stageRect();
  const newItem = {
    id: crypto.randomUUID(),
    catId: cat.id,
    name: cat.name,
    src: cat.src,
    x: r.width/2,
    y: r.height/2,
    scale: opts.scale ?? 1.0,
    rot: opts.rot ?? 0,
    op: opts.op ?? 1.0,
    hue: opts.hue ?? 0,
    sat: opts.sat ?? 1.0,
    z: ++zCounter,
    w: cat.w
  };
  items.push(newItem);
  mountItem(newItem);
  selectItem(newItem.id);
  updateSelectedCount();
}

function mountItem(it){
  const el = document.createElement("div");
  el.className="item";
  el.dataset.id = it.id;
  el.style.zIndex = it.z;

  const img = document.createElement("img");
  img.src = it.src;
  img.alt = it.name;
  img.style.width = it.w + "px";
  img.draggable = false;

  img.onerror = ()=>{
    $("#aiStatus").textContent = "‚ö†Ô∏è N√£o carregou: " + it.src + " (confira assets/ e nomes).";
  };

  el.appendChild(img);
  stage.appendChild(el);

  el.addEventListener("pointerdown", (e)=>startDrag(e, it.id));
  el.addEventListener("click", ()=>selectItem(it.id));

  applyTransform(it.id);
}

function getEl(id){ return stage.querySelector(`.item[data-id="${id}"]`); }

function applyTransform(id){
  const it = items.find(x=>x.id===id);
  const el = getEl(id);
  if(!it || !el) return;
  el.style.left = it.x + "px";
  el.style.top  = it.y + "px";
  el.style.zIndex = it.z;

  el.style.transform = `translate(-50%,-50%) rotate(${it.rot}deg) scale(${it.scale})`;
  el.style.opacity = it.op;

  const img = el.querySelector("img");
  // Hue + saturation (keeps realism better than recoloring)
  img.style.filter = `
    hue-rotate(${it.hue}deg)
    saturate(${it.sat})
    drop-shadow(0 18px 28px rgba(0,0,0,.45))
  `;
}

function selectItem(id){
  selectedId = id;
  stage.querySelectorAll(".item").forEach(n=>n.classList.remove("selected"));
  const el = getEl(id);
  if(el) el.classList.add("selected");

  const it = items.find(x=>x.id===id);
  if(!it){ syncControls(null); return; }
  syncControls(it);
}

function syncControls(it){
  if(!it){
    $("#rngScale").value = 100;
    $("#rngRot").value = 0;
    $("#rngOp").value = 100;
    $("#rngHue").value = 0;
    $("#rngSat").value = 100;
    return;
  }
  $("#rngScale").value = Math.round(it.scale*100);
  $("#rngRot").value = Math.round(it.rot);
  $("#rngOp").value = Math.round(it.op*100);
  $("#rngHue").value = Math.round(it.hue);
  $("#rngSat").value = Math.round(it.sat*100);
}

function updateSelectedCount(){
  selCount.textContent = items.length;
}

function removeSelected(){
  if(!selectedId) return;
  const idx = items.findIndex(x=>x.id===selectedId);
  if(idx<0) return;
  const el = getEl(selectedId);
  if(el) el.remove();
  items.splice(idx,1);
  selectedId = items.length ? items[items.length-1].id : null;
  if(selectedId) selectItem(selectedId);
  updateSelectedCount();
}

function clearAll(){
  items = [];
  selectedId = null;
  stage.querySelectorAll(".item").forEach(n=>n.remove());
  updateSelectedCount();
}

/* drag */
let drag = null;
function startDrag(e, id){
  e.preventDefault();
  selectItem(id);

  const it = items.find(x=>x.id===id);
  if(!it) return;
  const r = stageRect();

  drag = {
    id,
    startX: e.clientX,
    startY: e.clientY,
    origX: it.x,
    origY: it.y,
    rect: r
  };

  e.currentTarget.setPointerCapture(e.pointerId);
}
stage.addEventListener("pointermove", (e)=>{
  if(!drag) return;
  const it = items.find(x=>x.id===drag.id);
  if(!it) return;

  const dx = e.clientX - drag.startX;
  const dy = e.clientY - drag.startY;

  it.x = Math.max(0, Math.min(drag.rect.width, drag.origX + dx));
  it.y = Math.max(0, Math.min(drag.rect.height, drag.origY + dy));
  applyTransform(it.id);
});
stage.addEventListener("pointerup", ()=> drag=null);
stage.addEventListener("pointercancel", ()=> drag=null);

/* controls change */
function bindRange(id, fn){
  $(id).addEventListener("input", ()=>{
    if(!selectedId) return;
    const it = items.find(x=>x.id===selectedId);
    if(!it) return;
    fn(it, Number($(id).value));
    applyTransform(it.id);
  });
}
bindRange("#rngScale", (it,v)=> it.scale = v/100);
bindRange("#rngRot", (it,v)=> it.rot = v);
bindRange("#rngOp", (it,v)=> it.op = v/100);
bindRange("#rngHue", (it,v)=> it.hue = v);
bindRange("#rngSat", (it,v)=> it.sat = v/100);

/* buttons */
$("#btnDel").addEventListener("click", removeSelected);
$("#btnClearAll").addEventListener("click", clearAll);
$("#btnDup").addEventListener("click", ()=>{
  if(!selectedId) return;
  const it = items.find(x=>x.id===selectedId);
  if(!it) return;
  addItemFromCatalog(it.catId, {
    scale: it.scale,
    rot: it.rot,
    op: it.op,
    hue: it.hue,
    sat: it.sat
  });
  // nudge
  const n = items[items.length-1];
  n.x = it.x + 20; n.y = it.y + 20;
  applyTransform(n.id);
});
$("#btnFront").addEventListener("click", ()=>{
  if(!selectedId) return;
  const it = items.find(x=>x.id===selectedId);
  if(!it) return;
  it.z = ++zCounter;
  applyTransform(it.id);
});
$("#btnBack").addEventListener("click", ()=>{
  if(!selectedId) return;
  const it = items.find(x=>x.id===selectedId);
  if(!it) return;
  it.z = 1;
  applyTransform(it.id);
});
$("#btnCenter").addEventListener("click", ()=>{
  if(!selectedId) return;
  const it = items.find(x=>x.id===selectedId);
  if(!it) return;
  const r = stageRect();
  it.x = r.width/2; it.y = r.height/2;
  applyTransform(it.id);
});
$("#btnReset").addEventListener("click", ()=>{
  if(!selectedId) return;
  const it = items.find(x=>x.id===selectedId);
  if(!it) return;
  it.scale = 1; it.rot = 0; it.op = 1;
  applyTransform(it.id);
  syncControls(it);
});
$("#btnResetColor").addEventListener("click", ()=>{
  if(!selectedId) return;
  const it = items.find(x=>x.id===selectedId);
  if(!it) return;
  it.hue = 0; it.sat = 1;
  applyTransform(it.id);
  syncControls(it);
});

/* Whats / Copy */
$("#btnCopy").addEventListener("click", async ()=>{
  try{
    await navigator.clipboard.writeText($("#phoneText").textContent);
    $("#aiStatus").textContent = "‚úÖ WhatsApp copiado!";
  }catch{
    $("#aiStatus").textContent = "‚ö†Ô∏è N√£o consegui copiar. Copie manualmente: " + $("#phoneText").textContent;
  }
});
$("#btnWhats").addEventListener("click", ()=>{
  const phoneDigits = $("#phoneText").textContent.replace(/\D/g,"");
  // wa.me needs country code
  const url = "https://wa.me/55" + phoneDigits;
  window.open(url, "_blank");
});

/* =========================
   EXPORT (render to canvas)
   ========================= */
async function exportImage(){
  const r = stageRect();
  const canvas = document.createElement("canvas");
  const scale = 2; // export sharper
  canvas.width = Math.round(r.width*scale);
  canvas.height = Math.round(r.height*scale);
  const ctx = canvas.getContext("2d");

  // background (similar to stage)
  const grd = ctx.createLinearGradient(0,0,canvas.width,canvas.height);
  grd.addColorStop(0, "#151236");
  grd.addColorStop(1, "#0b1230");
  ctx.fillStyle = grd;
  ctx.fillRect(0,0,canvas.width,canvas.height);

  // sort by z
  const sorted = [...items].sort((a,b)=>a.z-b.z);

  for(const it of sorted){
    const img = await loadImg(it.src);
    // draw centered
    ctx.save();
    ctx.globalAlpha = it.op;

    ctx.translate(it.x*scale, it.y*scale);
    ctx.rotate((it.rot*Math.PI)/180);
    ctx.scale(it.scale*scale, it.scale*scale);

    // We can‚Äôt apply CSS hue-rotate easily in canvas without pixel ops.
    // So we export without hue (or you can keep hue only for preview).
    // If you want export with hue later, I implement pixel filter.
    const w = it.w;
    const ratio = img.naturalHeight / img.naturalWidth;
    const h = w * ratio;

    ctx.drawImage(img, -w/2, -h/2, w, h);
    ctx.restore();
  }

  const url = canvas.toDataURL("image/png");
  const a = document.createElement("a");
  a.href = url;
  a.download = "montagem-faz-de-conta.png";
  a.click();
  $("#aiStatus").textContent = "‚úÖ Exportei a imagem (download).";
}
function loadImg(src){
  return new Promise((res, rej)=>{
    const i = new Image();
    i.onload = ()=>res(i);
    i.onerror = ()=>rej(new Error("Erro ao carregar: "+src));
    i.src = src;
  });
}
$("#btnExport").addEventListener("click", ()=>{
  exportImage().catch(err=>{
    $("#aiStatus").textContent = "‚ö†Ô∏è N√£o consegui exportar. " + err.message;
  });
});

/* =========================
   ‚ÄúIA‚Äù LOCAL (auto montagem)
   ========================= */
function norm(s){return (s||"").toLowerCase();}
const COLOR_HINTS = {
  "azul": 210,
  "rosa": 320,
  "pink": 320,
  "roxo": 270,
  "lil√°s": 285,
  "lilas": 285,
  "vermelho": 0,
  "amarelo": 55,
  "verde": 120,
  "dourado": 45,
  "gold": 45,
  "branco": 0,
  "preto": 0,
};

function detectHue(text){
  text = norm(text);
  for(const k in COLOR_HINTS){
    if(text.includes(k)) return COLOR_HINTS[k];
  }
  return null;
}

function generateLayoutFromText(text){
  const t = norm(text);

  // clear stage first
  clearAll();

  // base positions
  const r = stageRect();
  const leftX  = r.width * 0.30;
  const midX   = r.width * 0.52;
  const rightX = r.width * 0.72;
  const topY   = r.height * 0.28;
  const midY   = r.height * 0.55;
  const botY   = r.height * 0.72;

  // choose hue (applied mostly to balloons + LED)
  const hue = detectHue(t);

  // Add LED if mentioned
  if(t.includes("led") || t.includes("luz") || t.includes("cortina")){
    addItemFromCatalog("led", {scale:1.15, rot:0, op:0.95, hue: hue ?? 50, sat:1.15});
    const it = items[items.length-1];
    it.x = midX; it.y = midY;
    it.z = 1; // behind
    applyTransform(it.id);
  }

  // Add arco structure if mentioned
  if(t.includes("arco") || t.includes("estrutura")){
    addItemFromCatalog("arco", {scale:1.1, rot:0, op:1, hue:0, sat:1});
    const it = items[items.length-1];
    it.x = midX; it.y = midY;
    it.z = 3;
    applyTransform(it.id);
  }

  // Add balloons if mentioned (or theme implies)
  if(t.includes("bal") || t.includes("balo") || t.includes("bal√£o") || t.includes("balao") || t.includes("arco org")){
    addItemFromCatalog("baloes", {scale:1.05, rot:0, op:1, hue: hue ?? 0, sat:1.2});
    const it = items[items.length-1];

    // side preference
    if(t.includes("esquer") || t.includes("lado esquerdo")){
      it.x = leftX; it.y = midY;
      it.rot = -6;
    } else if(t.includes("direit") || t.includes("lado direito")){
      it.x = rightX; it.y = midY;
      it.rot = 6;
    } else {
      it.x = leftX; it.y = midY;
      it.rot = -4;
    }
    it.z = 6;
    applyTransform(it.id);
  }

  // Tapete if mentioned
  if(t.includes("tapete") || t.includes("carpete") || t.includes("ch√£o") || t.includes("chao")){
    addItemFromCatalog("tapete", {scale:1.05, rot:0, op:0.95, hue: detectHue(t) ?? 0, sat:1.0});
    const it = items[items.length-1];
    it.x = midX; it.y = botY;
    it.z = 2;
    applyTransform(it.id);
  }

  // Cylinders if mentioned
  if(t.includes("cilind") || t.includes("suporte") || t.includes("mesa") || t.includes("base")){
    addItemFromCatalog("cilindros", {scale:1.0, rot:0, op:1, hue:0, sat:1});
    const it = items[items.length-1];
    it.x = midX; it.y = botY - 20;
    it.z = 5;
    applyTransform(it.id);
  }

  // If user asks "centro", shift main items to center
  if(t.includes("centro")){
    items.forEach(it=>{
      it.x = Math.min(r.width-10, Math.max(10, it.x + (midX - it.x)*0.35));
      applyTransform(it.id);
    });
  }

  // select last item
  if(items.length) selectItem(items[items.length-1].id);
  $("#aiStatus").textContent = "‚úÖ Cen√°rio gerado! Agora voc√™ pode arrastar e ajustar.";
}

/* IA buttons */
$("#btnAi").addEventListener("click", ()=>{
  const text = $("#aiText").value.trim();
  if(!text){
    $("#aiStatus").textContent = "Escreva algo (ou toque em üéôÔ∏è Falar).";
    return;
  }
  $("#aiStatus").textContent = "Gerando cen√°rio‚Ä¶";
  setTimeout(()=> generateLayoutFromText(text), 200);
});
$("#btnAiClear").addEventListener("click", ()=>{
  $("#aiText").value = "";
  $("#aiStatus").textContent = "";
});

/* =========================
   VOICE (SpeechRecognition)
   ========================= */
let recognizing = false;
let rec = null;

function initSpeech(){
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if(!SR) return null;
  const r = new SR();
  r.lang = "pt-BR";
  r.interimResults = true;
  r.continuous = false;
  return r;
}

$("#btnMic").addEventListener("click", ()=>{
  if(recognizing){
    rec && rec.stop();
    return;
  }
  rec = initSpeech();
  if(!rec){
    $("#micStatus").textContent = "‚ö†Ô∏è Seu navegador n√£o suporta microfone por voz aqui. Use o Chrome no Android.";
    return;
  }

  recognizing = true;
  $("#micStatus").textContent = "üéôÔ∏è Ouvindo‚Ä¶ fale agora (ex.: ‚Äúarco de bal√µes rosa, led no fundo e tapete‚Äù).";
  $("#btnMic").textContent = "‚èπÔ∏è Parar";

  rec.onresult = (ev)=>{
    let finalText = "";
    let interim = "";
    for(let i=ev.resultIndex; i<ev.results.length; i++){
      const txt = ev.results[i][0].transcript;
      if(ev.results[i].isFinal) finalText += txt + " ";
      else interim += txt;
    }
    const base = $("#aiText").value.trim();
    const merged = (base ? base + " " : "") + (finalText || interim);
    $("#aiText").value = merged.trim();
  };

  rec.onerror = (e)=>{
    $("#micStatus").textContent = "‚ö†Ô∏è Erro no microfone: " + (e.error || "desconhecido");
  };

  rec.onend = ()=>{
    recognizing = false;
    $("#btnMic").textContent = "üéôÔ∏è Falar";
    $("#micStatus").textContent = "‚úÖ Pronto. Se quiser, toque em ‚Äú‚ú® Gerar cen√°rio‚Äù.";
  };

  rec.start();
});

/* =========================
   START: add nothing by default
   ========================= */
updateSelectedCount();
</script>
</body>
</html>
