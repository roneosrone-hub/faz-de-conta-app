<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Faz de Conta Decora√ß√µes ‚Ä¢ Montagem</title>

  <!-- Konva (canvas editor) -->
  <script src="https://unpkg.com/konva@9/konva.min.js"></script>

  <style>
    :root{
      --bg0:#070916;
      --bg1:#0b1230;
      --card: rgba(255,255,255,.08);
      --card2: rgba(255,255,255,.06);
      --stroke: rgba(255,255,255,.14);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.65);
      --shadow: 0 18px 50px rgba(0,0,0,.55);
      --radius: 18px;
      --radius2: 14px;
      --accent: #7cf0d6;
      --accent2:#8aa7ff;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color:var(--text);
      background:
        radial-gradient(1100px 520px at 20% -10%, rgba(124,240,214,.18), transparent 55%),
        radial-gradient(900px 560px at 110% 20%, rgba(138,167,255,.18), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
    }

    .wrap{max-width:1200px;margin:0 auto;padding:16px}
    .topTag{
      display:inline-flex;gap:8px;align-items:center;
      padding:6px 10px;border:1px solid var(--stroke);
      border-radius:999px;background:rgba(255,255,255,.06);
      color:var(--text);font-weight:700;font-size:12px;
    }

    .header{
      margin-top:12px;
      background:linear-gradient(135deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
      border:1px solid var(--stroke);
      border-radius:22px;
      box-shadow:var(--shadow);
      padding:14px;
      display:grid;
      grid-template-columns: 120px 1fr;
      gap:14px;
    }
    .logoBox{
      width:120px;height:120px;border-radius:18px;
      background:rgba(0,0,0,.35);
      border:1px solid var(--stroke);
      display:flex;align-items:center;justify-content:center;
      overflow:hidden;
    }
    .logoBox img{width:100%;height:100%;object-fit:cover}
    .brand h1{
      margin:0;
      font-size:28px;letter-spacing:.5px;
      background: linear-gradient(90deg, #b46cff, #53e6ff, #9aff7a, #ffdd6b, #ff6bd8);
      -webkit-background-clip:text;background-clip:text;color:transparent;
      font-weight:900;
    }
    .brand .sub{
      margin-top:6px;
      color:var(--muted);
      font-weight:800;
      text-shadow:0 10px 26px rgba(0,0,0,.45);
      font-size:14px;
      display:flex;gap:8px;align-items:center;
    }
    .chips{margin-top:12px;display:flex;flex-wrap:wrap;gap:10px}
    .chip{
      padding:10px 12px;border-radius:999px;
      border:1px solid var(--stroke);
      background:rgba(255,255,255,.06);
      color:var(--text);
      font-weight:800;
      display:inline-flex;align-items:center;gap:8px;
      cursor:pointer;
      user-select:none;
    }
    .chip.primary{
      background:linear-gradient(90deg, rgba(124,240,214,.20), rgba(138,167,255,.14));
    }
    .chip.danger{background:rgba(255,80,80,.12)}
    .chip input{display:none}

    .meta{
      margin-top:10px;
      display:grid;
      gap:8px;
    }
    .metaRow{
      border:1px solid var(--stroke);
      background:rgba(255,255,255,.05);
      border-radius:14px;
      padding:10px 12px;
      color:var(--muted);
      font-weight:800;
      display:flex;align-items:center;gap:10px;
    }
    .metaRow b{color:var(--text)}
    .grid{
      margin-top:14px;
      display:grid;
      grid-template-columns: 1.3fr .7fr;
      gap:14px;
    }
    @media (max-width: 980px){
      .grid{grid-template-columns:1fr}
    }

    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.04));
      border:1px solid var(--stroke);
      border-radius:22px;
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .cardHead{
      padding:12px 14px;
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      border-bottom:1px solid rgba(255,255,255,.08);
    }
    .cardHead .title{
      font-weight:900;
      display:flex;align-items:center;gap:10px;
      color:var(--text);
    }
    .cardHead .hint{
      color:var(--muted);font-weight:800;font-size:12px;
    }
    #stageWrap{
      height:420px;
      background: radial-gradient(900px 380px at 20% 0%, rgba(124,240,214,.10), transparent 55%),
                  radial-gradient(900px 380px at 90% 40%, rgba(138,167,255,.10), transparent 55%),
                  rgba(0,0,0,.25);
      border-top:1px solid rgba(255,255,255,.06);
      border-bottom:1px solid rgba(255,255,255,.06);
    }

    .panel{
      padding:12px 14px;
      display:grid;
      gap:10px;
    }
    .field{
      display:grid;
      gap:6px;
    }
    label{font-size:12px;color:var(--muted);font-weight:900}
    input[type="text"], select{
      width:100%;
      padding:12px 12px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.25);
      color:var(--text);
      outline:none;
      font-weight:800;
    }
    .row{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    .row3{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap:10px;
    }
    @media (max-width: 520px){
      .row, .row3{grid-template-columns:1fr}
    }

    .toggle{
      display:flex;align-items:center;gap:10px;justify-content:space-between;
      padding:10px 12px;border:1px solid rgba(255,255,255,.12);
      border-radius:12px;background:rgba(255,255,255,.04);
    }
    .toggle span{color:var(--muted);font-weight:900}
    .toggle input{transform:scale(1.2)}

    .controls{
      display:grid;
      gap:10px;
      padding:12px 14px;
      border-top:1px solid rgba(255,255,255,.08);
    }
    .slider{
      display:grid;gap:6px;
    }
    .slider .top{
      display:flex;align-items:center;justify-content:space-between;
      color:var(--muted);font-weight:900;font-size:12px;
    }
    input[type="range"]{width:100%}

    .btnRow{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap:10px;
    }
    @media (max-width: 520px){ .btnRow{grid-template-columns:1fr} }
    .btn{
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);
      color:var(--text);
      font-weight:900;
      cursor:pointer;
      user-select:none;
      display:flex;align-items:center;justify-content:center;gap:8px;
    }
    .btn.primary{background:linear-gradient(90deg, rgba(124,240,214,.22), rgba(138,167,255,.16))}
    .btn.danger{background:rgba(255,80,80,.12)}
    .btn:active{transform:translateY(1px)}

    .catalog{
      padding:12px 14px 14px;
      display:grid;
      gap:10px;
    }
    .catGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }
    @media (max-width: 520px){ .catGrid{grid-template-columns:1fr} }

    .item{
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.05);
      border-radius:16px;
      overflow:hidden;
      cursor:pointer;
      user-select:none;
    }
    .thumb{
      height:110px;
      background:rgba(0,0,0,.30);
      display:flex;align-items:center;justify-content:center;
    }
    .thumb img{width:100%;height:100%;object-fit:cover}
    .itemBody{padding:10px 10px 12px}
    .itemBody .nm{font-weight:900}
    .itemBody .ds{color:var(--muted);font-weight:800;font-size:12px;margin-top:4px}
    .itemBody .pr{margin-top:8px;color:var(--muted);font-weight:900;font-size:12px;display:none}
    .showPrices .itemBody .pr{display:block}

    .smallNote{color:var(--muted);font-weight:800;font-size:12px;line-height:1.35}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topTag">‚ú® Onde a imagina√ß√£o vira festa</div>

    <section class="header">
      <div class="logoBox">
        <img id="logoImg" alt="Logo" src="assets/logo.png" onerror="this.style.display='none'; this.parentElement.textContent='FC';"/>
      </div>
      <div class="brand">
        <h1>FAZ DE CONTA DECORA√á√ïES</h1>
        <div class="sub">‚ú® <span>Onde a imagina√ß√£o vira festa</span></div>

        <div class="chips">
          <div class="chip primary" id="btnWhats">üí¨ WhatsApp</div>
          <div class="chip" id="chipCount">üß∫ Selecionados <b id="countSel" style="margin-left:6px">0</b></div>
          <div class="chip danger" id="btnClear">üßΩ Limpar montagem</div>
          <div class="chip primary" id="btnExport">üì∏ Exportar imagem</div>
          <label class="chip" style="cursor:pointer">
            ‚¨ÜÔ∏è Enviar item (PNG)
            <input id="fileAdd" type="file" accept="image/*">
          </label>
        </div>

        <div class="meta">
          <div class="metaRow">üìç <b>Jaciara/MT</b></div>
          <div class="metaRow">üì± <span>WhatsApp:</span> <b id="whatsNum">(66) 99622-3481</b></div>
          <div class="metaRow">üìÖ <b id="dtNow"></b> ‚è±Ô∏è <b id="tmNow"></b></div>
        </div>
      </div>
    </section>

    <section class="grid">
      <!-- Montagem -->
      <div class="card">
        <div class="cardHead">
          <div class="title">üß© Montagem do cliente</div>
          <div class="hint">Toque no item no cat√°logo ‚Üí ele entra aqui. Arraste e ajuste.</div>
        </div>
        <div id="stageWrap"></div>

        <div class="controls">
          <div class="smallNote">
            Dica: para ficar realista, use PNG/WebP com fundo transparente. JPG quase sempre ‚Äúvira foto inteira‚Äù.
          </div>

          <div class="row3">
            <div class="slider">
              <div class="top"><span>Escala</span><b id="vScale">100%</b></div>
              <input id="scaleR" type="range" min="20" max="220" value="100">
            </div>
            <div class="slider">
              <div class="top"><span>Rota√ß√£o</span><b id="vRot">0¬∞</b></div>
              <input id="rotR" type="range" min="-180" max="180" value="0">
            </div>
            <div class="slider">
              <div class="top"><span>Opacidade</span><b id="vOp">100%</b></div>
              <input id="opR" type="range" min="10" max="100" value="100">
            </div>
          </div>

          <div class="btnRow">
            <div class="btn" id="btnFront">‚¨ÜÔ∏è Frente</div>
            <div class="btn" id="btnBack">‚¨áÔ∏è Tr√°s</div>
            <div class="btn" id="btnDup">üß¨ Duplicar</div>
          </div>

          <div class="btnRow">
            <div class="btn" id="btnCenter">üéØ Centralizar</div>
            <div class="btn" id="btnResetColor">üé® Reset cor</div>
            <div class="btn danger" id="btnDel">üóëÔ∏è Remover</div>
          </div>

          <div class="row">
            <div class="slider">
              <div class="top"><span>Cor (Hue)</span><b id="vHue">0</b></div>
              <input id="hueR" type="range" min="0" max="360" value="0">
            </div>
            <div class="slider">
              <div class="top"><span>Satura√ß√£o</span><b id="vSat">100%</b></div>
              <input id="satR" type="range" min="0" max="200" value="100">
            </div>
          </div>
        </div>
      </div>

      <!-- Assistente do pedido -->
      <div class="card">
        <div class="cardHead">
          <div class="title">üß† Assistente de montagem</div>
          <div class="hint">Buscar e filtrar itens</div>
        </div>

        <div class="panel">
          <div class="field">
            <label>Pesquisar</label>
            <input id="q" type="text" placeholder="Pesquisar (ex: arco, bal√µes, tapete, LED...)">
          </div>

          <div class="field">
            <label>Categoria</label>
            <select id="cat">
              <option value="all">Todas as categorias</option>
            </select>
          </div>

          <div class="toggle" id="togglePrices">
            <span>üîí Mostrar pre√ßos</span>
            <input id="showPrices" type="checkbox">
          </div>

          <div class="btn primary" id="btnResetFilters">üßº Limpar filtros</div>

          <div class="smallNote">
            Observa√ß√£o: se as imagens ‚Äúsomem‚Äù no Vercel, √© quase sempre nome de arquivo diferente (mai√∫scula/min√∫scula) ou pasta errada.
          </div>
        </div>

        <div class="catalog">
          <div class="title" style="font-weight:900">‚ú® Itens do cat√°logo (toque para adicionar)</div>
          <div class="catGrid" id="grid"></div>
        </div>
      </div>
    </section>
  </div>

  <script>
    // ===========
    // DATA/HORA
    // ===========
    function pad(n){ return String(n).padStart(2,'0'); }
    function updateClock(){
      const d = new Date();
      document.getElementById('dtNow').textContent = pad(d.getDate()) + '/' + pad(d.getMonth()+1) + '/' + d.getFullYear();
      document.getElementById('tmNow').textContent = pad(d.getHours()) + ':' + pad(d.getMinutes());
    }
    updateClock();
    setInterval(updateClock, 15000);

    // ===========
    // CAT√ÅLOGO (edite aqui os itens e caminhos)
    // Coloque suas imagens em /assets/ (nomes min√∫sculos!)
    // ===========
    const CATALOG = [
      { id:'baloes', name:'Bal√µes (Arco Org√¢nico)', cat:'Bal√µes', price:'sob consulta', desc:'Bal√µes realistas para montagem.', src:'assets/baloes.png' },
      { id:'arco', name:'Arco (Estrutura)', cat:'Estruturas', price:'sob consulta', desc:'Estrutura para arco/painel.', src:'assets/arco.png' },
      { id:'painel', name:'Painel Redondo', cat:'Pain√©is', price:'sob consulta', desc:'Painel redondo (fundo).', src:'assets/painel-redondo.png' },
      { id:'cilindros', name:'Cilindros (Suporte)', cat:'Estruturas', price:'sob consulta', desc:'Cilindros para mesa/bolo.', src:'assets/cilindros.png' },
      { id:'led', name:'Cortina de LED', cat:'Ilumina√ß√£o', price:'sob consulta', desc:'LED para fundo e brilho.', src:'assets/cortina-led.png' },
      { id:'tapete', name:'Tapete para fotos', cat:'Cen√°rio', price:'sob consulta', desc:'Tapete para base.', src:'assets/tapete.png' },
    ];

    // ===========
    // UI cat√°logo
    // ===========
    const grid = document.getElementById('grid');
    const q = document.getElementById('q');
    const catSel = document.getElementById('cat');
    const showPrices = document.getElementById('showPrices');
    const body = document.body;

    // popular categorias
    const cats = Array.from(new Set(CATALOG.map(i=>i.cat))).sort();
    for(const c of cats){
      const opt = document.createElement('option');
      opt.value = c;
      opt.textContent = c;
      catSel.appendChild(opt);
    }

    function renderCatalog(){
      const term = (q.value||'').trim().toLowerCase();
      const cat = catSel.value;

      grid.innerHTML = '';
      const items = CATALOG.filter(it=>{
        const okTerm = !term || (it.name.toLowerCase().includes(term) || it.desc.toLowerCase().includes(term));
        const okCat = (cat==='all') || (it.cat===cat);
        return okTerm && okCat;
      });

      for(const it of items){
        const card = document.createElement('div');
        card.className = 'item';
        card.innerHTML = `
          <div class="thumb"><img src="${it.src}" alt="${it.name}" loading="lazy"
            onerror="this.style.display='none'; this.parentElement.textContent='Imagem n√£o encontrada';"></div>
          <div class="itemBody">
            <div class="nm">${it.name}</div>
            <div class="ds">${it.desc}</div>
            <div class="pr">Pre√ßo: ${it.price}</div>
          </div>
        `;
        card.addEventListener('click', ()=> addItemToStage(it));
        grid.appendChild(card);
      }
    }

    q.addEventListener('input', renderCatalog);
    catSel.addEventListener('change', renderCatalog);
    showPrices.addEventListener('change', ()=>{
      body.classList.toggle('showPrices', showPrices.checked);
    });

    document.getElementById('btnResetFilters').addEventListener('click', ()=>{
      q.value='';
      catSel.value='all';
      showPrices.checked=false;
      body.classList.remove('showPrices');
      renderCatalog();
    });

    renderCatalog();

    // ===========
    // KONVA stage
    // ===========
    const stageWrap = document.getElementById('stageWrap');

    function makeStage(){
      const w = stageWrap.clientWidth;
      const h = stageWrap.clientHeight;

      const stage = new Konva.Stage({
        container: 'stageWrap',
        width: w,
        height: h
      });

      const layerBG = new Konva.Layer();
      const layer = new Konva.Layer();

      stage.add(layerBG);
      stage.add(layer);

      // fundo (opcional)
      const bgRect = new Konva.Rect({
        x:0,y:0,width:w,height:h,
        fillLinearGradientStartPoint: {x:0, y:0},
        fillLinearGradientEndPoint: {x:w, y:h},
        fillLinearGradientColorStops: [0,'rgba(0,0,0,0.18)', 1,'rgba(255,255,255,0.06)']
      });
      layerBG.add(bgRect);

      // transformer
      const tr = new Konva.Transformer({
        rotateEnabled: true,
        ignoreStroke: true,
        keepRatio: false,
        enabledAnchors: ['top-left','top-right','bottom-left','bottom-right'],
        boundBoxFunc: (oldBox, newBox) => {
          // evita sumir por ficar pequeno demais
          if (newBox.width < 30 || newBox.height < 30) return oldBox;
          return newBox;
        }
      });
      layer.add(tr);

      // clique no vazio desmarca
      stage.on('pointerdown', (e)=>{
        if(e.target === stage || e.target === bgRect){
          tr.nodes([]);
          selected = null;
          syncUI();
        }
      });

      layerBG.draw();
      layer.draw();

      return {stage, layerBG, layer, tr};
    }

    let {stage, layerBG, layer, tr} = makeStage();
    let selected = null;
    let selectedMeta = null;
    let selectedCount = 0;

    // resize responsivo
    window.addEventListener('resize', ()=>{
      const data = exportState(); // salva
      stage.destroy();
      ({stage, layerBG, layer, tr} = makeStage());
      importState(data); // restaura
    });

    // ===========
    // Helpers (carregar imagem)
    // ===========
    function loadImage(src){
      return new Promise((resolve, reject)=>{
        const img = new Image();
        img.crossOrigin = 'anonymous';
        img.onload = ()=> resolve(img);
        img.onerror = ()=> reject(new Error('Falha ao carregar: ' + src));
        img.src = src;
      });
    }

    // ===========
    // Adicionar item na montagem
    // ===========
    async function addItemToStage(item){
      try{
        const img = await loadImage(item.src);

        const maxW = stage.width() * 0.55;
        const maxH = stage.height() * 0.70;

        const scale = Math.min(maxW / img.width, maxH / img.height, 1);

        const kimg = new Konva.Image({
          image: img,
          x: stage.width()/2,
          y: stage.height()/2,
          offsetX: img.width/2,
          offsetY: img.height/2,
          scaleX: scale,
          scaleY: scale,
          draggable: true,
          shadowColor: 'rgba(0,0,0,.55)',
          shadowBlur: 18,
          shadowOffset: {x:0, y:10},
          shadowOpacity: 0.35
        });

        // metadados
        kimg.setAttr('meta', {
          id: item.id,
          name: item.name,
          cat: item.cat
        });

        // selecionar ao tocar
        kimg.on('pointerdown', ()=>{
          selected = kimg;
          tr.nodes([kimg]);
          selectedMeta = kimg.getAttr('meta');
          selectedCount++;
          document.getElementById('countSel').textContent = String(layer.children.length - 1); // - transformer
          syncUI();
        });

        layer.add(kimg);
        layer.draw();

        // auto selecionar
        selected = kimg;
        tr.nodes([kimg]);
        syncUI();

        document.getElementById('countSel').textContent = String(layer.children.length - 1);
      }catch(err){
        alert(
          "N√£o consegui carregar a imagem.\n\n" +
          "Confira se o arquivo existe em /assets e se o nome est√° igualzinho (min√∫sculo/sem espa√ßo).\n\n" +
          "Detalhe: " + err.message
        );
      }
    }

    // ===========
    // UI controls
    // ===========
    const scaleR = document.getElementById('scaleR');
    const rotR   = document.getElementById('rotR');
    const opR    = document.getElementById('opR');
    const hueR   = document.getElementById('hueR');
    const satR   = document.getElementById('satR');

    function syncUI(){
      const has = !!selected;
      const setDisabled = (el, v)=> el.disabled = !has;

      [scaleR, rotR, opR, hueR, satR].forEach(el=>setDisabled(el));

      if(!has){
        document.getElementById('vScale').textContent = '100%';
        document.getElementById('vRot').textContent = '0¬∞';
        document.getElementById('vOp').textContent = '100%';
        document.getElementById('vHue').textContent = '0';
        document.getElementById('vSat').textContent = '100%';
        return;
      }

      const sc = Math.round(selected.scaleX() * 100);
      const rt = Math.round(selected.rotation());
      const op = Math.round(selected.opacity() * 100);

      scaleR.value = sc;
      rotR.value = rt;
      opR.value = op;

      document.getElementById('vScale').textContent = sc + '%';
      document.getElementById('vRot').textContent = rt + '¬∞';
      document.getElementById('vOp').textContent = op + '%';

      // hue/sat guardados em attrs
      const fx = selected.getAttr('fx') || {hue:0, sat:100};
      hueR.value = fx.hue;
      satR.value = fx.sat;
      document.getElementById('vHue').textContent = String(fx.hue);
      document.getElementById('vSat').textContent = fx.sat + '%';
    }

    function applyHueSat(node, hue, sat){
      // Konva HSL filter
      node.cache();
      node.filters([Konva.Filters.HSL]);
      // Konva HSL: hue (-180..180), saturation (-1..1), luminance (-1..1)
      // Vamos mapear:
      const hueNorm = (hue > 180) ? hue - 360 : hue; // 0..360 -> -180..180
      const satNorm = (sat - 100) / 100; // 0..200 -> -1..+1
      node.hue(hueNorm);
      node.saturation(satNorm);
      node.luminance(0);
      node.setAttr('fx', {hue, sat});
      layer.batchDraw();
    }

    scaleR.addEventListener('input', ()=>{
      if(!selected) return;
      const v = Number(scaleR.value)/100;
      selected.scaleX(v);
      selected.scaleY(v);
      document.getElementById('vScale').textContent = Math.round(v*100)+'%';
      layer.batchDraw();
    });

    rotR.addEventListener('input', ()=>{
      if(!selected) return;
      const v = Number(rotR.value);
      selected.rotation(v);
      document.getElementById('vRot').textContent = v+'¬∞';
      layer.batchDraw();
    });

    opR.addEventListener('input', ()=>{
      if(!selected) return;
      const v = Number(opR.value)/100;
      selected.opacity(v);
      document.getElementById('vOp').textContent = Math.round(v*100)+'%';
      layer.batchDraw();
    });

    hueR.addEventListener('input', ()=>{
      if(!selected) return;
      const hue = Number(hueR.value);
      const sat = Number(satR.value);
      document.getElementById('vHue').textContent = String(hue);
      applyHueSat(selected, hue, sat);
    });

    satR.addEventListener('input', ()=>{
      if(!selected) return;
      const hue = Number(hueR.value);
      const sat = Number(satR.value);
      document.getElementById('vSat').textContent = sat+'%';
      applyHueSat(selected, hue, sat);
    });

    document.getElementById('btnFront').addEventListener('click', ()=>{
      if(!selected) return;
      selected.moveToTop();
      tr.moveToTop();
      layer.batchDraw();
    });

    document.getElementById('btnBack').addEventListener('click', ()=>{
      if(!selected) return;
      selected.moveToBottom();
      layer.batchDraw();
    });

    document.getElementById('btnDup').addEventListener('click', ()=>{
      if(!selected) return;
      const clone = selected.clone({ x: selected.x()+20, y: selected.y()+20, draggable:true });
      clone.on('pointerdown', ()=>{
        selected = clone;
        tr.nodes([clone]);
        selectedMeta = clone.getAttr('meta');
        syncUI();
      });
      layer.add(clone);
      layer.batchDraw();
      document.getElementById('countSel').textContent = String(layer.children.length - 1);
    });

    document.getElementById('btnDel').addEventListener('click', ()=>{
      if(!selected) return;
      selected.destroy();
      tr.nodes([]);
      selected = null;
      layer.batchDraw();
      document.getElementById('countSel').textContent = String(layer.children.length - 1);
      syncUI();
    });

    document.getElementById('btnCenter').addEventListener('click', ()=>{
      if(!selected) return;
      selected.position({x: stage.width()/2, y: stage.height()/2});
      layer.batchDraw();
    });

    document.getElementById('btnResetColor').addEventListener('click', ()=>{
      if(!selected) return;
      selected.clearCache();
      selected.filters([]);
      selected.setAttr('fx', {hue:0, sat:100});
      hueR.value = 0; satR.value = 100;
      document.getElementById('vHue').textContent = '0';
      document.getElementById('vSat').textContent = '100%';
      layer.batchDraw();
    });

    // ===========
    // Limpar montagem
    // ===========
    document.getElementById('btnClear').addEventListener('click', ()=>{
      const kids = layer.getChildren().toArray().filter(n=> n !== tr);
      kids.forEach(n=>n.destroy());
      tr.nodes([]);
      selected = null;
      layer.batchDraw();
      document.getElementById('countSel').textContent = '0';
      syncUI();
    });

    // ===========
    // Export PNG
    // ===========
    document.getElementById('btnExport').addEventListener('click', ()=>{
      // tira transformer antes de exportar
      const old = tr.nodes();
      tr.nodes([]);
      layer.draw();

      const uri = stage.toDataURL({ pixelRatio: 2 });

      // volta transformer
      tr.nodes(old);
      layer.draw();

      const a = document.createElement('a');
      a.href = uri;
      a.download = 'montagem-faz-de-conta.png';
      a.click();
    });

    // ===========
    // WhatsApp
    // ===========
    document.getElementById('btnWhats').addEventListener('click', ()=>{
      const num = "5566996223481"; // ajuste se quiser
      const count = layer.children.length - 1; // - transformer
      const msg = encodeURIComponent(
        "Oi! Fiz uma pr√©via da minha decora√ß√£o no site da Faz de Conta. " +
        "Itens na montagem: " + count + ". " +
        "Pode me ajudar a fechar o or√ßamento?"
      );
      window.open("https://wa.me/" + num + "?text=" + msg, "_blank");
    });

    // ===========
    // Upload de imagem do cliente (para voc√™ testar itens)
    // ===========
    document.getElementById('fileAdd').addEventListener('change', async (ev)=>{
      const f = ev.target.files && ev.target.files[0];
      if(!f) return;

      const url = URL.createObjectURL(f);
      const temp = { id:'upload', name:f.name, cat:'Upload', price:'-', desc:'Item enviado', src:url };
      await addItemToStage(temp);

      // limpa input pra permitir enviar o mesmo arquivo de novo
      ev.target.value = "";
    });

    // ===========
    // Persist√™ncia simples (pra n√£o quebrar no resize)
    // ===========
    function exportState(){
      const nodes = layer.getChildren().toArray()
        .filter(n=> n !== tr)
        .map(n=>{
          const meta = n.getAttr('meta') || {};
          const fx = n.getAttr('fx') || {hue:0,sat:100};
          return {
            src: (n.image() && n.image().src) ? n.image().src : null,
            x:n.x(), y:n.y(),
            offX:n.offsetX(), offY:n.offsetY(),
            scX:n.scaleX(), scY:n.scaleY(),
            rot:n.rotation(),
            op:n.opacity(),
            fx,
            meta
          };
        });
      return {nodes};
    }

    async function importState(state){
      if(!state || !state.nodes) return;
      for(const s of state.nodes){
        try{
          const img = await loadImage(s.src);
          const n = new Konva.Image({
            image: img,
            x: s.x, y: s.y,
            offsetX: s.offX, offsetY: s.offY,
            scaleX: s.scX, scaleY: s.scY,
            rotation: s.rot,
            opacity: s.op,
            draggable: true,
            shadowColor: 'rgba(0,0,0,.55)',
            shadowBlur: 18,
            shadowOffset: {x:0, y:10},
            shadowOpacity: 0.35
          });
          n.setAttr('meta', s.meta || {});
          n.on('pointerdown', ()=>{
            selected = n;
            tr.nodes([n]);
            syncUI();
          });
          layer.add(n);
          if(s.fx && (s.fx.hue !== 0 || s.fx.sat !== 100)){
            applyHueSat(n, s.fx.hue, s.fx.sat);
          }
        }catch(e){
          // ignora
        }
      }
      layer.draw();
      document.getElementById('countSel').textContent = String(layer.children.length - 1);
    }

    // inicial
    syncUI();
  </script>
</body>
</html>
